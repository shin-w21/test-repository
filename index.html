<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 3.5mè·é›¢ãƒãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .info-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 300px;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #cc3333;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .error {
            color: #ff4444;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>AR 3.5mè·é›¢ãƒãƒ¼ã‚«ãƒ¼</h3>
        <div id="status">ARã‚’é–‹å§‹ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸ</div>
        <div>ğŸ“ ç¾åœ¨ä½ç½®ã‹ã‚‰3.5må…ˆã«èµ¤ã„ç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div>ğŸ§­ ãƒ‡ãƒã‚¤ã‚¹ã‚’æ°´å¹³ã«æŒã£ã¦å‘¨ã‚Šã‚’è¦‹å›ã—ã¦ãã ã•ã„</div>
    </div>
    
    <div class="controls">
        <button id="startAR">ARã‚’é–‹å§‹</button>
        <button id="resetPosition" disabled>ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="toggleLine" disabled>ç·šã®è¡¨ç¤ºåˆ‡æ›¿</button>
    </div>

    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        style="display: none;"
    >
        <!-- ã‚¢ã‚»ãƒƒãƒˆå®šç¾© -->
        <a-assets>
            <a-mixin id="redMaterial" material="color: #ff0000; opacity: 0.8;"></a-mixin>
        </a-assets>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-camera
            id="camera"
            position="0 1.6 0"
            look-controls="enabled: true"
            wasd-controls="enabled: false"
        >
        </a-camera>
        
        <!-- ãƒ©ã‚¤ãƒˆ -->
        <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
        <a-light type="directional" position="0 5 0" color="#ffffff" intensity="0.4"></a-light>
        
        <!-- 3.5måœ°ç‚¹ã®èµ¤ã„ç·šã¨ãƒãƒ¼ã‚«ãƒ¼ -->
        <a-entity id="distanceMarkers">
            <!-- å‰æ–¹3.5måœ°ç‚¹ã®å‚ç›´ãªèµ¤ã„ç·š -->
            <a-box
                id="frontLine"
                position="0 0 -3.5"
                width="0.05"
                height="2"
                depth="0.05"
                mixin="redMaterial"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
            ></a-box>
            
            <!-- å·¦å´3.5måœ°ç‚¹ã®å‚ç›´ãªèµ¤ã„ç·š -->
            <a-box
                id="leftLine"
                position="-3.5 0 0"
                width="0.05"
                height="2"
                depth="0.05"
                mixin="redMaterial"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
            ></a-box>
            
            <!-- å³å´3.5måœ°ç‚¹ã®å‚ç›´ãªèµ¤ã„ç·š -->
            <a-box
                id="rightLine"
                position="3.5 0 0"
                width="0.05"
                height="2"
                depth="0.05"
                mixin="redMaterial"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
            ></a-box>
            
            <!-- å¾Œæ–¹3.5måœ°ç‚¹ã®å‚ç›´ãªèµ¤ã„ç·š -->
            <a-box
                id="backLine"
                position="0 0 3.5"
                width="0.05"
                height="2"
                depth="0.05"
                mixin="redMaterial"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
            ></a-box>
            
            <!-- 3.5må††å‘¨ä¸Šã®å††å½¢ã‚¬ã‚¤ãƒ‰ -->
            <a-torus
                id="distanceCircle"
                position="0 0 0"
                color="#ff0000"
                radius="3.5"
                radius-tubular="0.02"
                opacity="0.6"
                rotation="-90 0 0"
            ></a-torus>
            
            <!-- ä¸­å¿ƒç‚¹ãƒãƒ¼ã‚«ãƒ¼ -->
            <a-sphere
                id="centerMarker"
                position="0 0 0"
                radius="0.1"
                color="#00ff00"
                opacity="0.8"
                animation="property: scale; to: 1.2 1.2 1.2; direction: alternate; loop: true; dur: 1000"
            ></a-sphere>
            
            <!-- è·é›¢è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆï¼ˆå‰æ–¹ï¼‰ -->
            <a-text
                position="0 2.5 -3.5"
                value="3.5m"
                color="#ff0000"
                align="center"
                width="8"
                look-at="#camera"
            ></a-text>
        </a-entity>
    </a-scene>

    <script>
        let arActive = false;
        let lineVisible = true;
        let camera, scene, distanceMarkers;

        // DOMè¦ç´ ã®å–å¾—
        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startAR');
        const resetButton = document.getElementById('resetPosition');
        const toggleButton = document.getElementById('toggleLine');
        const arScene = document.getElementById('arScene');

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
        function updateStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'error' : 'status';
        }

        // ARã®åˆæœŸåŒ–
        async function initializeAR() {
            try {
                // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã®è¨±å¯ã‚’è¦æ±‚
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // A-Frameã‚·ãƒ¼ãƒ³ã®è¦ç´ ã‚’å–å¾—
                scene = document.querySelector('#arScene');
                camera = document.querySelector('#camera');
                distanceMarkers = document.querySelector('#distanceMarkers');
                
                // ARã‚·ãƒ¼ãƒ³ã‚’è¡¨ç¤º
                arScene.style.display = 'block';
                arActive = true;
                
                updateStatus('ARé–‹å§‹ - ãƒ‡ãƒã‚¤ã‚¹ã‚’æ°´å¹³ã«æŒã£ã¦å‘¨ã‚Šã‚’è¦‹å›ã—ã¦ãã ã•ã„');
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                startButton.disabled = true;
                resetButton.disabled = false;
                toggleButton.disabled = false;
                
                // ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã®ç›£è¦–é–‹å§‹
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
                
            } catch (error) {
                console.error('ARåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', true);
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã®å‡¦ç†
        function handleOrientation(event) {
            if (!arActive || !camera) return;
            
            // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã«åŸºã¥ã„ã¦ã‚«ãƒ¡ãƒ©ã®å‘ãã‚’èª¿æ•´
            const alpha = event.alpha || 0; // Zè»¸å›è»¢
            const beta = event.beta || 0;   // Xè»¸å›è»¢
            const gamma = event.gamma || 0; // Yè»¸å›è»¢
            
            // ã‚«ãƒ¡ãƒ©ã®å›è»¢ã‚’æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
            if (camera.getAttribute('rotation')) {
                camera.setAttribute('rotation', {
                    x: beta - 90,
                    y: alpha,
                    z: -gamma
                });
            }
        }

        // ä½ç½®ã®ãƒªã‚»ãƒƒãƒˆ
        function resetPosition() {
            if (camera && distanceMarkers) {
                camera.setAttribute('position', '0 1.6 0');
                camera.setAttribute('rotation', '0 0 0');
                updateStatus('ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }
        }

        // ç·šã®è¡¨ç¤ºåˆ‡æ›¿
        function toggleLineVisibility() {
            if (distanceMarkers) {
                lineVisible = !lineVisible;
                distanceMarkers.setAttribute('visible', lineVisible);
                toggleButton.textContent = lineVisible ? 'ç·šã‚’éè¡¨ç¤º' : 'ç·šã‚’è¡¨ç¤º';
                updateStatus(lineVisible ? 'è·é›¢ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º' : 'è·é›¢ãƒãƒ¼ã‚«ãƒ¼ã‚’éè¡¨ç¤º');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        startButton.addEventListener('click', initializeAR);
        resetButton.addEventListener('click', resetPosition);
        toggleButton.addEventListener('click', toggleLineVisibility);

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // WebXRã‚µãƒãƒ¼ãƒˆã®ç¢ºèª
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Webã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“', true);
                startButton.disabled = true;
                return;
            }
            
            updateStatus('ARã‚’é–‹å§‹ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸ');
        });

        // A-Frameã‚·ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        document.querySelector('a-scene').addEventListener('loaded', function() {
            console.log('A-Frameã‚·ãƒ¼ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            console.error('ã‚¨ãƒ©ãƒ¼:', event.error);
            updateStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error.message, true);
        });
    </script>
</body>
</html>
